{% extends 'base.html.twig' %}

{% block title %}Evenement{% endblock %}

{% block body %}

{#}
<div class="col-12">
            <!-- Form Element sizes -->
            <div class="card card-secondary">
              <div class="card-header">
                <h3 class="card-title">Calendrier des Missions</h3> 
              </div>
              <div class="card-body">
                      <table class="table table-bordered">
    <thead>
        <tr>
            <th>Id</th>
            <th>Titre</th>
            <th>Début</th>
            <th>Fin</th>
            <th>Description</th>
            
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ evenement.id }}</td>
            <td>{{ evenement.titre }}</td>
            <td>{{ evenement.debut ? evenement.debut|date('Y-m-d') : '' }}</td>
            <td>{{ evenement.fin ? evenement.fin|date('Y-m-d') : '' }}</td>
            <td>{{ evenement.description }}</td>
            
        </tr>
    </tbody>
</table>
              </div>
              <!-- /.card-body -->
         </div>
    </div>#}

<figure style="font-size: 14pt;">
  <blockquote class="blockquote" style="font-size: 20pt;">
    <h3>Objet: {{ evenement.titre }}  </h3>
  </blockquote>
  <figcaption class="blockquote-footer">
        Type de la mission: <cite title="Source Title">{{ evenement.mission.Type }}</cite>
    </figcaption>
    <figcaption class="blockquote-footer">
        Bailleur: <cite title="Source Title">{{ evenement.mission.Bailleur }}</cite>
           
    </figcaption>
</figure>

<div class="row align-items-start">
       <div class="col-6">
            <!-- Form Element sizes -->
            <div class="card card-secondary">
              <div class="card-header">
                <h3 class="card-title">Missions<a href="{{ path('app_for_mission', {'id':  evenement.id}) }}" class="btn btn-secondary">
                <i class="fa-solid fa-screwdriver-wrench" style="color: #FFFFF;"></i></a></h3> 
                
                <a href="{{ path('etat_mission_avance_pdf', {evenementId: evenement.id}) }}" 
                class="btn btn-sm btn-primary" style="float: right;" target="_blank">
                <i class="fa fa-file-pdf"></i> État avance PDF
                </a>

                {% if evenement.imageName is null or evenement.imageName == '' %}
                      <a href="#" 
                class="btn btn-sm btn-primary" style="float: right;" id="btnReliquat">
                <i class="fa fa-file-pdf"></i> État reliquat PDF
                </a>           
                {% else %}
                    <a href="{{ path('etat_reliquat_pdf', {evenementId: evenement.id}) }}" 
                class="btn btn-sm btn-primary" style="float: right;" target="_blank">
                <i class="fa fa-file-pdf"></i> État reliquat PDF
                </a>                    
                {% endif %}                
                

                
              </div>
              <div class="card-body">
                  <table class="table table-bordered">
                        <tbody>
                            <tr>
                                <th>Objet</th>
                                <td>{{ evenement.titre }}</td>
                            </tr>
                            <tr>
                                <th>Date début</th>
                                <td>{{ evenement.debut ? evenement.debut|date('d-m-Y') : '' }}</td>
                            </tr>
                            <tr>
                                <th>Date fin</th>
                                <td>{{ evenement.fin ? evenement.fin|date('d-m-Y') : '' }}</td>
                            </tr>
                            <tr>
                                <th>Description</th>
                                <td>{{ evenement.description }}</td>
                            </tr>
                            <tr>
                                <th>Nombres de jour</th>
                                <td>
                                {% if evenement.debut and evenement.fin %}
                                {# Calculate the date difference in days #}
                                {% set debutTimestamp = evenement.debut.timestamp() %}
                                {% set finTimestamp = evenement.fin.timestamp() %}
                                {% set duration = ((finTimestamp - debutTimestamp) / 86400) | round(0, 'floor') %}
                                {{ duration + 1 }}
                                {% else %}
                                N/A
                                {% endif %} Jours
                                </td>
                            </tr>
                            <tr >
                                <th>Chauffeur</th>
                                <td>
                                    {% if evenement.chauffeur %}
                                        {{ evenement.chauffeur.nom }} {{ evenement.chauffeur.prenom }}
                                        <a style="float: right;" href="{{ path('chauffeur_mission_pdf', {
                                            'evenementId': evenement.id, 
                                            'chauffeurId': evenement.Chauffeur.id
                                        }) }}" target="_blank" class="btn btn-secondary">
                                            <i class="fa-solid fa-print"></i>
                                        </a>
                                    {% else %}
                                        Aucun chauffeur assigné
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Destination</th>
                                <td></td>
                            </tr>
                            <tr>
                                <th>Bailleur</th>
                                <td>{{ evenement.bailleur }}</td>
                            </tr>
                            <tr>
                                <th>Etat</th>
                                    {% set currentDate = "now"|date("Y-m-d") %}

                                    {% set reservations = [] %}
                                    {% set enCours = [] %}
                                    {% set finis = [] %}
                                <td>
                                    {% if evenement.debut.format("Y-m-d") <= currentDate and currentDate <= evenement.fin.format("Y-m-d") %}
                                    <span class="status btn btn-success">En cours</span>
                                    {% elseif  evenement.fin.format("Y-m-d") > currentDate %}
                                    <span class="status btn btn-warning">Provisoire </span>
                                    {% else %}
                                    {% if evenement.imageName is empty %}
                                        <span class="status btn btn-secondary">En attente de finalisation</span>
                                    {% else %}
                                        <span class="status btn btn-danger">Finie</span>
                                    {% endif %}
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Rapport</th>
                                <td>
                                {% set currentDate = "now"|date("Y-m-d") %}
                                {% if evenement.fin.format("Y-m-d") <= currentDate  %}
                                  <a href="#" class="btn btn-info edit-btn_evenement" data-id="{{ evenement.id }}">
                                    <i class="fas fa-edit"></i> 
                                </a>  
                                {% else %}
                                <a href="#" class="btn btn-info " id="btnRapport">
                                    <i class="fas fa-edit"></i> 
                                </a>
                                
                                {% endif %}
                                 
                                {% if evenement.imageName %}
                                        {% set extension = evenement.imageName|split('.')|last|lower %}
                                        
                                        {% if extension in ['jpg','jpeg','png','gif'] %}
                                            <button class="btn btn-info view-btn" style="float: right;"
                                                    data-file="{{ asset('uploads/rapports/' ~ evenement.imageName) }}" 
                                                    data-type="image">
                                                <i class="fa-solid fa-eye"></i> Voir
                                            </button>
                                        {% elseif extension == 'pdf' %}
                                            <button class="btn btn-info view-btn" style="float: right;"
                                                    data-file="{{ asset('images/products/' ~ evenement.imageName) }}" 
                                                    data-type="pdf">
                                                <i class="fa-solid fa-eye"></i> Voir
                                            </button>
                                        {% else %}
                                            <a href="{{ asset('uploads/rapports/' ~ evenement.imageName) }}" target="_blank" class="btn btn-info">
                                                <i class="fa-solid fa-eye"></i> Voir
                                            </a>
                                        {% endif %}
                                    {% else %}
                                        Pas de fichier
                                    {% endif %}



                                </td>
                            </tr>
                            </tr>
                            
                        </tbody>
                    </table>
              </div>
              <!-- /.card-body -->
         </div>
    </div>

     <div class="col-6">
            <!-- Form Element sizes -->
            <div class="card card-secondary">
              <div class="card-header">
              
                <h3 class="card-title">Menbres de la mission</h3>
                {% set currentDate = "now"|date("Y-m-d") %}
                {% if evenement.debut.format("Y-m-d") >= currentDate  %}
                <a data-bs-toggle="modal" data-bs-target="#addAgentModal"  style="float: right;" class="btn btn-primary"><i class="fa-sharp fa-solid fa-plus"></i></a>
                {% endif %}
                
                <a href="{{ path('evenement_pdf', {'id': evenement.id}) }}" target="_blank" class="btn btn-primary" style="float: right;">
                                        <i class="fa-solid fa-print"></i>
                                    </a>


              </div>
              <div class="card-body">
                  <table class="table table-striped table-bordered text-center"  id="example3">
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>Prenom</th>
                                    <th>Service</th>
                                    <th>Fonction</th>
                                    <th>Lieu d'emploi</th>
                                    <th></th>
                                    
                                </tr>
                            </thead>
                            <tbody>
                            {% if evenement.agents|length > 0 %}
                            {% for agent in evenement.agents %}
                                <tr data-id="{{ agent.id }}">
                                    <td>{{ agent.nom }}</td>
                                    <td>{{ agent.prenom }}</td>
                                    <td>{{ agent.service }}</td>
                                    <td>{{ agent.fonction }}</td>
                                    <td>{{ agent.lienEmpl }}</td>
                                    <td>
                                    <a href="{{ path('agent_mission_pdf', {'evenementId': evenement.id, 'agentId': agent.id}) }}" 
                                    target="_blank" 
                                    class="btn btn-secondary">
                                    <i class="fa-solid fa-print"></i>
                                    </a>
                                    {% set currentDate = "now"|date("Y-m-d") %}
                                    {% if evenement.debut.format("Y-m-d") >= currentDate  %}
                                    <button class="btn btn-danger btn-sm remove-agent-btn" data-agent-id="{{ agent.id }}">
                                    <i class="fa fa-times" aria-hidden="true"></i></button>
                                    </td>
                                    {% endif %}
                                    
                                </tr>
                            {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="9">Auccun menbres n'es assigner à la mission</td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
              </div>
              <!-- /.card-body -->
            </div>
     </div>
 </div>











{#
<div class="alert alert-info">
             
</div>

<p>
    <strong>Véhicule associé :</strong>
    {% if evenement.vehicule %}
        {{ evenement.vehicule.Imatriculation }}-{{ evenement.vehicule.marque }} 
    {% else %}
        Aucun véhicule associé.
    {% endif %}
</p>

<p>
    <strong>Agents associés :</strong>
    {% if evenement.agents|length > 0 %}
        <ul>
        {% for agent in evenement.agents %}
            <li>
                {{ agent.nom }}
                <button class="btn btn-danger btn-sm remove-agent-btn" data-agent-id="{{ agent.id }}">Retirer</button>
            </li>
        {% endfor %}
        </ul>
    {% else %}
        Aucun agent associé.
    {% endif %}
</p>
<p>
    <strong>Bailleurs associés :</strong>
    {% if evenement.bailleurs is not empty %}
        <ul>
        {% for bailleur in evenement.bailleurs %}
                <li>{{ bailleur.nom }}</li> 
        {% endfor %}
        </ul>
    {% else %}
        Aucun bailleur associé.
    {% endif %}
</p>
    <h1>Evenement</h1>

    <table class="table">
        <tbody>
            <tr>
                <th>Id</th>
                <td>{{ evenement.id }}</td>
            </tr>
            <tr>
                <th>Titre</th>
                <td>{{ evenement.titre }}</td>
            </tr>
            <tr>
                <th>Debut</th>
                <td>{{ evenement.debut ? evenement.debut|date('Y-m-d') : '' }}</td>
            </tr>
            <tr>
                <th>Fin</th>
                <td>{{ evenement.fin ? evenement.fin|date('Y-m-d') : '' }}</td>
            </tr>
            <tr>
                <th>Description</th>
                <td>{{ evenement.description }}</td>
            </tr>
            <tr>
                <th>Background_color</th>
                <td>{{ evenement.backgroundColor }}</td>
            </tr>
            <tr>
                <th>Border_color</th>
                <td>{{ evenement.borderColor }}</td>
            </tr>
            <tr>
                <th>Text_color</th>
                <td>{{ evenement.textColor }}</td>
            </tr>
        </tbody>
    </table>

    <a href="{{ path('app_evenement_index') }}">back to list</a>

    <a href="{{ path('app_evenement_edit', {'id': evenement.id}) }}">edit</a>

    {{ include('evenement/_delete_form.html.twig') }}#}


    <!-- Modal Bootstrap -->
<div class="modal fade" id="addAgentModal" tabindex="-1" aria-labelledby="addAgentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addAgentModalLabel">Ajouter des agents à la mission</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"><i class="fa fa-times" aria-hidden="true"></i></button>
      </div>
      <div class="modal-body">
        <input type="text" id="agent-search" class="form-control" placeholder="Rechercher un agent...">
        <ul id="agent-results" class="list-group mt-2"></ul>
      </div>
    </div>
  </div>
</div>



    <!-- Modal Bootstrap -->
<!-- Modal Bootstrap pour l'édition -->
    <div class="modal fade" id="editEvenementModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Ajout du Rapport de fin de mission</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"><i class="fa fa-window-close" aria-hidden="true"></i></button>
                </div>
                <div class="modal-body">
                    <div id="editEvenementRapportForm"></div> {# Le formulaire sera chargé ici #}
                </div>
            </div>
        </div>
    </div>


<div class="modal fade" id="viewFileModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img src="" id="viewFileImage" class="img-fluid d-none" alt="Image">
        <iframe src="" id="viewFilePdf" class="w-100" style="height:600px; display:none;" frameborder="0"></iframe>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>




<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('agent-search');
    const resultsList = document.getElementById('agent-results');
    const evenementId = {{ evenement.id }};
    let timeout = null;

    // Recherche et ajout d'agent
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            clearTimeout(timeout);
            const query = this.value;
            if (query.length < 1) {
                resultsList.innerHTML = '';
                return;
            }
            timeout = setTimeout(function() {
                fetch('/agent/search?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        resultsList.innerHTML = '';
                        data.forEach(agent => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item d-flex justify-content-between align-items-center';
                            li.textContent = agent.nom + ' ' + agent.prenom + ' - ' + agent.service;
                            const btn = document.createElement('button');
                            btn.className = 'btn btn-primary btn-sm';
                            btn.textContent = 'Ajouter';
                            btn.onclick = function() {
                                fetch('/evenement/' + evenementId + '/add-agent', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-Requested-With': 'XMLHttpRequest',
                                        'X-CSRF-TOKEN': '{{ csrf_token("add_agent") }}'
                                    },
                                    body: JSON.stringify({ agentId: agent.id })
                                })
                                .then(resp => resp.json())
                                .then(resp => {
                                    if (resp.success) {
                                        li.remove();
                                        window.location.reload();
                                    } else if (resp.message) {
                                        alert(resp.message);
                                    }
                                });
                            };
                            li.appendChild(btn);
                            resultsList.appendChild(li);
                        });
                    });
            }, 300);
        });
    }

    // Suppression d'agent (Retirer)
    document.querySelectorAll('.remove-agent-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            if (!confirm('Retirer cet agent de la mission ?')) return;
            fetch('/evenement/' + evenementId + '/remove-agent/' + btn.dataset.agentId, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(resp => resp.json())
            .then(resp => {
                if (resp.success) {
                    window.location.reload();
                } else if (resp.message) {
                    alert(resp.message);
                }
            });
        });
    });
});



function imprimerOrdre(id) {
    var ligne = document.querySelector("tr[data-id='" + id + "']").children;
    var contenu = "<html><head><title>Ordre de Mission</title></head><body>";

    var win = window.open("", "", "width=800,height=600");
    win.document.write(contenu);
    win.document.close();
}






document.addEventListener("DOMContentLoaded", function () {
    // Récupère l'ID de l'événement courant

    document.querySelectorAll(".edit-btn_evenement").forEach(button => {
        button.addEventListener("click", function (event) {
            event.preventDefault();

            const evenementId = this.getAttribute("data-id"); 

            fetch(`/evenement/rapport/${evenementId}/edit`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.form) {
                    document.getElementById("editEvenementRapportForm").innerHTML = data.form;
                    const editModal = new bootstrap.Modal(document.getElementById("editEvenementModal"));
                    editModal.show();
                }
            })
            .catch(error => console.error("Erreur lors du chargement du formulaire :", error));
        });
    });

    // Soumission du formulaire AJAX
    document.addEventListener("submit", function (event) {
        const form = event.target.closest("#editEvenementRapportForm form");
        if (!form) return;

        event.preventDefault();
        const formData = new FormData(form);

        fetch(form.action, {
            method: "POST",
            body: formData,
            headers: { "X-Requested-With": "XMLHttpRequest" }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("Mission mise à jour avec succès !");
                location.reload();
            } else {
                alert("Erreur : " + (data.errors || "Une erreur inconnue s'est produite"));
            }
        })
        .catch(error => console.error("Erreur lors de la mise à jour :", error));
    });
});


document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.view-btn').forEach(button => {
        button.addEventListener('click', function() {
            const fileUrl = this.dataset.file;
            const type = this.dataset.type;
            const img = document.getElementById('viewFileImage');
            const pdf = document.getElementById('viewFilePdf');

            // Reset
            img.classList.add('d-none');
            pdf.style.display = 'none';
            img.src = "";
            pdf.src = "";

            if (type === 'image') {
                img.src = fileUrl;
                img.classList.remove('d-none');
            } else if (type === 'pdf') {
                pdf.src = fileUrl;
                pdf.style.display = 'block';
            }

            const modal = new bootstrap.Modal(document.getElementById('viewFileModal'));
            modal.show();
        });
    });
});

document.addEventListener('DOMContentLoaded', function() {
    const btnReliquat = document.querySelector('#btnReliquat');
    if (btnReliquat) {
        btnReliquat.addEventListener('click', function(e) {
            e.preventDefault();
            alert("La mission n'est encore finalisée pour le moment !");
        });
    }
});

document.addEventListener('DOMContentLoaded', function() {
    const btnReliquat = document.querySelector('#btnRapport');
    if (btnReliquat) {
        btnReliquat.addEventListener('click', function(e) {
            e.preventDefault();
            alert("La mission n'est encore fini pour le moment !");
        });
    }
});







</script>
{% endblock %}
