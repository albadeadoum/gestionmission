{% extends 'base.html.twig' %}

{% block title %}Liste des Entretiens{% endblock %}

{% block body %}
<div class="row align-items-start">
    <div class="col">
        <div class="card card-secondary">
            <div class="card-header">
                <h3 class="card-title">Liste des Entretiens</h3>
                {% if is_granted('ROLE_ADMIN') %}
                    {#
                    <a href="{{ path('app_piece_new') }}" style="float: right;" class="btn btn-primary"> 
                        <i class="fa-sharp fa-solid fa-plus"></i>
                    </a>
                    

                    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addPieceModal">
                        <i class="fa-solid fa-plus"></i> Ajouter
                    </button>#}

                    <a   data-bs-toggle="modal" data-bs-target="#addPieceModal" style="float: right;" class="btn btn-primary"> 
                        <i class="fa-sharp fa-solid fa-plus"></i>
                    </a>
                    
                {% endif %}
            </div>
            <div class="card-body">

            
                {% set currentYear = "now"|date("Y") %}
                {% set totalCost = 0 %}
                {% set totalCostAnnée = 0 %}
                {% set entretienCount = 0 %}
                {% set entretien = 0 %}
                {% for piece in pieces %}
                    {% set totalCost = totalCost + piece.cout %}
                    {% set entretien = entretien + 1 %}
                {% endfor %}
                {% for piece in pieces %}
                    {% if piece.Date and piece.Date|date("Y") == currentYear %}
                        {% set totalCostAnnée = totalCostAnnée + piece.cout %}
                        {% set entretienCount = entretienCount + 1 %}
                    {% endif %}
                {% endfor %}
                
                {#<div class="alert alert-info">
                    <strong>Coût Total des Entretiens :</strong> {{ totalCost }} F CFA<br>
                    <strong>Nombre d'entretiens :</strong> {{ entretienCount }} <br>
                </div>#}
                <div class="alert alert-info">
                    <strong>Année :</strong> {{ currentYear }} <br>
                    <strong>Nombre d'entretiens :</strong> {{ entretienCount }} <br>
                    <strong>Coût Total :</strong> {{ totalCost }} F CFA
                </div>

                <table id="example2" class="table table-striped table-bordered text-center">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Véhicule</th>
                            <th>Mission</th>
                            <th>Marque</th>
                            <th>Description</th>
                            <th>Quantité</th>
                            <th>Coût</th>
                            <th>L.Reparation</th>
                            <th>Observation</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for piece in pieces %}
                            <tr data-id="{{ piece.id }}">
                                <td>{{ piece.Date ? piece.Date|date('d-m-Y') : '' }}</td>
                                <td>{{ piece.Vehicule }}</td>
                                <td>{{ piece.event }}</td>
                                <td>{{ piece.Vehicule.Marque }}</td>
                                <td>{{ piece.Nom }}</td>
                                <td>{{ piece.Quantitite }}</td>
                                <td>{{ piece.cout }} F CFA</td>
                                <td>{{ piece.garage }} </td>
                                <td>{{ piece.Observation }}</td>
                                <td>
                                    {% if is_granted('ROLE_ADMIN') %}
                                        {#<a href="{{ path('app_piece_edit', {'id': piece.id}) }}" class="btn btn-info">
                                            <i class="fa-solid fa-pen-to-square"></i>
                                        </a>#}
                                        
                                        <a href="#" class="btn btn-info edit-btn_piece" data-id="{{ piece.id }}">
                                            <i class="fas fa-edit"></i> 
                                        </a>
                                                        {% endif %}
                                    <button onclick="imprimerPiece({{ piece.id }})" class="btn btn-secondary">
                                        <i class="fa-solid fa-print"></i> 
                                    </button>
                                    <a class="btn">{{ include('piece/_delete_form.html.twig') }}</a>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="8">Aucun enregistrement trouvé</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>



{#
<!-- Modal pour Ajouter une Pièce -->
<div class="modal fade" id="addPieceModal" tabindex="-1" aria-labelledby="addPieceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addPieceModalLabel">Ajouter une Pièce</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addPieceForm">
                    <div class="mb-3">
                        <label for="vehicule" class="form-label">Véhicule</label>
                        <input type="text" class="form-control" id="vehicule" name="vehicule" required>
                    </div>
                    <div class="mb-3">
                        <label for="marque" class="form-label">Marque</label>
                        <input type="text" class="form-control" id="marque" name="marque" required>
                    </div>
                    <div class="mb-3">
                        <label for="description" class="form-label">Description</label>
                        <textarea class="form-control" id="description" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="quantite" class="form-label">Quantité</label>
                        <input type="number" class="form-control" id="quantite" name="quantite" required>
                    </div>
                    <div class="mb-3">
                        <label for="cout" class="form-label">Coût</label>
                        <input type="number" class="form-control" id="cout" name="cout" required>
                    </div>
                    <div class="mb-3">
                        <label for="observation" class="form-label">Observation</label>
                        <textarea class="form-control" id="observation" name="observation"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Enregistrer</button>
                </form>
            </div>
        </div>
    </div>
</div>
#}

 <!-- Modal Bootstrap -->
<div class="modal fade" id="addPieceModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalLabel">Ajouter une anomalier</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                {{ form_start(form) }}
                    {{ form_widget(form, {'attr': {'id': 'MotoForm'}}) }}
                    <button class="btn btn-success" style="margin-right: 10px;">{{ button_label|default('Enregistrer') }}</button>
                    <button type="reset" class="btn btn-secondary" style="float: right;">{{ button_label2|default('Vider') }}</button>
                {{ form_end(form) }}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Bootstrap pour l'édition -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">Modifier des donnée chauffeur</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="editModalContent"></div> {# Le formulaire sera chargé ici #}
                </div>
            </div>
        </div>
    </div>







<!-- Script pour l'impression -->
<script>
    /*function imprimerPiece(id) {
        var ligne = document.querySelector("tr[data-id='" + id + "']").children;
        var contenu = `
            <html>
            <head>
                <title>Fiche d’Anomalies ou de Demande d’Intervention</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .header, h2, h3 { text-align: center; }
                    .logo { text-align: center; margin-bottom: 20px; }
                    .logo img { width: 120px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid black; padding: 8px; text-align: left; }
                    .signature { margin-top: 30px; text-align: left; }
                </style>
            </head>
            <body>
                <div class="logo">
                    <img src="{{ absolute_url(asset('ins-logo.png')) }}" alt="Logo Niger">
                </div>
                <h2>RÉPUBLIQUE DU NIGER</h2>
                <h3>MINISTÈRE DE L’ÉCONOMIE ET DES FINANCES</h3>
                <h4>INSTITUT NATIONAL DE LA STATISTIQUE</h4>
                <h3>FICHE D’ANOMALIES OU DE DEMANDE D’INTERVENTION</h3>

                <table>
                    <tr><th>N° VÉHICULE :</th><td>${ligne[1].innerText}</td></tr>
                    <tr><th>MARQUE :</th><td>${ligne[2].innerText}</td></tr>
                    <tr><th>DATE :</th><td>${ligne[0].innerText}</td></tr>
                </table>

                <h4>Anomalies constatées :</h4>
                <p>${ligne[3].innerText}</p>

                <table>
                    <tr><th>Quantité :</th><td>${ligne[4].innerText}</td></tr>
                    <tr><th>Coût :</th><td>${ligne[5].innerText}</td></tr>
                    <tr><th>Observation :</th><td>${ligne[6].innerText}</td></tr>
                    <tr><th>Date de la dernière intervention :</th><td>../../2024</td></tr>
                    <tr><th>Date de la dernière vidange :</th><td>../../2024</td></tr>
                    <tr><th>Lieu de l’intervention :</th><td>Garage Sahel</td></tr>
                    <tr><th>Date d’entrée :</th><td>… /…/2024</td></tr>
                    <tr><th>Date de sortie :</th><td>… /…/2024</td></tr>
                </table>

                <h4>VISA</h4>
                <p>CSL/INS : ……………………………..</p>
                <p>DML/INS : ……………………………..</p>
                <p>DRFM/INS : ……………………………..</p>
                <p>CMP/OB/INS : …………………………</p>
                <p>SG/INS : ……………………………..</p>

                <h3 class="signature">APPROBATION DE LA DIRECTION GÉNÉRALE</h3>

                <script>
                    window.onload = function() {
                        window.print();
                    };
                <\/script>
            </body>
            </html>
        `;

        var win = window.open("", "", "width=800,height=600");
        win.document.write(contenu);
        win.document.close();
    }

  function imprimerPiece(id) {
    var ligne = document.querySelector("tr[data-id='" + id + "']").children;
    var contenu = `
        <html>
        <head>
            <title>FICHE D'ANOMALIES OU DE DEMANDE D'INTERVENTION</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                }
                .header {
                    display: flex;
                    margin-bottom: 10px;
                }
                .logo {
                    width: 100px;
                    height: 100px;
                    border: 1px solid #000;
                    margin-right: 20px;
                    text-align: center;
                    line-height: 100px;
                    font-size: 12px;
                }
                .header-text {
                    flex: 1;
                }
                .header-text div {
                    margin-bottom: 5px;
                }
                .ministry {
                    font-weight: bold;
                    margin-top: 10px;
                }
                .document-title {
                    text-align: center;
                    font-weight: bold;
                    margin: 20px 0;
                    text-decoration: underline;
                }
                .table-border {
                    border: 1px solid #000;
                    padding: 10px;
                    margin-bottom: 20px;
                }
                .vehicle-info {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .anomalies-box {
                    border: 1px solid #000;
                    padding: 10px;
                    margin: 10px 0;
                }
                .anomalies-title {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .signature-line {
                    margin: 5px 0;
                    display: flex;
                }
                .signature-label {
                    width: 150px;
                    font-weight: bold;
                }
                .signature-dots {
                    flex: 1;
                    border-bottom: 1px dotted #000;
                    margin-left: 10px;
                }
                .approval {
                    font-weight: bold;
                    margin-top: 30px;
                    text-decoration: underline;
                }
                @media print {
                    body {
                        padding: 0;
                    }
                    .no-print {
                        display: none;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="logo">
                <img src="{{ absolute_url(asset('ins-logo.png')) }}" alt="Logo Niger" style="height: 200px; width: 120px; "></div>
                <div class="header-text">
                    <div>RÉPUBLIQUE DU NIGER</div>
                    <div>Fraternité - Travail - Progrès</div>
                    <div class="ministry">MINISTERE DE L'ECONOMIE ET DES FINANCES</div>
                    <div class="ministry">INSTITUT NATIONAL DE LA STATISTIQUE</div>
                    <div>Établissement Public à Caractère Administratif</div>
                    <div>Direction des Ressources Financières et du Matériel</div>
                    <div>Division du Matériel et de la Logistique</div>
                    <div>Service de la Logistique</div>
                </div>
            </div>

            <div class="document-title">FICHE D'ANOMALIES OU DE DEMANDE D'INTERVENTION</div>

            <div class="table-border">
                <div class="vehicle-info-container">
  <div class="info-row header">
    <div class="info-cell">N° VÉHICULE</div>
    <div class="info-cell">DIRECTION</div>
    <div class="info-cell">SIGNATURE</div>
    <div class="info-cell">DATE</div>
  </div>
  <div class="info-row data">
    <div class="info-cell">${ligne[1].innerText}</div>
    <div class="info-cell">${ligne[2].innerText}</div>
    <div class="info-cell"></div>
    <div class="info-cell">${ligne[0].innerText}</div>
  </div>
</div>

<style>
  .vehicle-info-container {
    font-family: Arial, sans-serif;
    margin: 15px 0;
    border: 1px solid #ddd;
  }
  
  .info-row {
    display: flex;
    border-bottom: 1px solid #eee;
  }
  
  .info-row:last-child {
    border-bottom: none;
  }
  
  .info-cell {
    flex: 1;
    padding: 10px;
    text-align: center;
  }
  
  .header .info-cell {
    font-weight: bold;
    background-color: #f8f8f8;
  }
  
  @media (max-width: 600px) {
    .info-row {
      flex-direction: column;
    }
    .info-cell {
      text-align: left;
      border-bottom: 1px dotted #ddd;
    }
  }
</style>
                <div class="anomalies-box">
                    <div class="anomalies-title">ANOMALIES CONSTATEES PAR le mecaniciem interne</div>
                    <div>- ${ligne[4].innerText}</div>
                </div>

                <div class="document-info">
  <div class="info-item">
    <div class="info-title">DATE DE LA DERNIERE INTERVENTION</div>
    <div class="info-data">../../2025</div>
  </div>
  <div class="info-item">
    <div class="info-title">DATE DE LA DERNIERE VIDANGE</div>
    <div class="info-data">../../2025</div>
  </div>
  <div class="info-item">
    <div class="info-title">LIEU DE L'INTERVENTION</div>
    <div class="info-data">GARAGE sahel</div>
  </div>
  <div class="info-item">
    <div class="info-title">DATE D'entree</div>
    <div class="info-data">... /.../2025</div>
  </div>
  <div class="info-item">
    <div class="info-title">DATE DE SORTIE</div>
    <div class="info-data">.../.../2025</div>
  </div>
</div>

<style>
  .document-info {
    margin: 15px 0;
  }
  
  .info-item {
    display: flex;
    margin-bottom: 8px;
    line-height: 2.5;
  }
  
  .info-title {
    flex: 1;
    font-weight: bold;
  }
  
  .info-data {
    width: 150px;
    text-align: right;
  }
  
  @media (max-width: 600px) {
    .info-item {
      flex-direction: column;
      line-height: 1.5;
    }
    .info-data {
      text-align: left;
      width: auto;
      padding-left: 20px;
    }
  }
</style>

                <div class="signature-line" style="line-height: 2.5;>
                    <div class="signature-label">VISA DU CSL/INS</div>
                    <div class="signature-dots"></div>
                </div>
                <div class="signature-line" style="line-height: 2.5;>
                    <div class="signature-label">VISA DU DML/INS</div>
                    <div class="signature-dots"></div>
                </div>
                <div class="signature-line" style="line-height: 2.5;>
                    <div class="signature-label">VISA DU DRFM/INS</div>
                    <div class="signature-dots"></div>
                </div>
                <div class="signature-line" style="line-height: 2.5;>
                    <div class="signature-label">visa du cmp/ob/ins</div>
                    <div class="signature-dots"></div>
                </div>
                <div class="signature-line" style="line-height: 2.5;>
                    <div class="signature-label">VISA DU SG/INS ...</div>
                    <div class="signature-dots"></div>
                </div>

                <div class="approval">APPROBATION DE LA DIRECTION GENERALE</div>
            </div>

            <script>
                window.onload = function() {
                    window.print();
                };
            <\/script>
        </body>
        </html>
    `;

    var win = window.open("", "", "width=800,height=600");
    win.document.write(contenu);
    win.document.close();
}  
*/

function imprimerPiece(id) {
    var ligne = document.querySelector("tr[data-id='" + id + "']").children;
    var contenu = `
        <html>
        <head>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                }
                .header {
                    display: flex;
                    margin-bottom: 10px;
                }
                .logo {
                    width: 100px;
                    height: 100px;
                    border: 1px solid #000;
                    margin-right: 20px;
                    text-align: center;
                    line-height: 100px;
                    font-size: 12px;
                }
                .header-text {
                    flex: 1;
                }
                .header-text div {
                    margin-bottom: 5px;
                }
                .ministry {
                    font-weight: bold;
                    margin-top: 10px;
                }
                .document-title {
                    text-align: center;
                    font-weight: bold;
                    margin: 20px 0;
                    text-decoration: underline;
                }
                .table-border {
                    border: 1px solid #000;
                    padding: 10px;
                    margin-bottom: 20px;
                }
                .vehicle-info {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .anomalies-box {
                    border: 1px solid #000;
                    padding: 10px;
                    margin: 10px 0;
                }
                .anomalies-title {
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .signature-line {
                    margin: 5px 0;
                    display: flex;
                }
                .signature-label {
                    width: 150px;
                    font-weight: bold;
                }
                .signature-dots {
                    flex: 1;
                    border-bottom: 1px dotted #000;
                    margin-left: 10px;
                }
                .approval {
                    font-weight: bold;
                    margin-top: 30px;
                    text-decoration: underline;
                }
                @media print {
                    body {
                        padding: 0;
                    }
                    .no-print {
                        display: none;
                    }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <table style="float: left;width:552.85pt;border-collapse:collapse;border:none;margin-left:4.8pt;margin-right:4.8pt;">
                    <tbody>
                        <tr>
                            <td style="width:120.5pt;padding:0cm 5.4pt 0cm 5.4pt;height:130.4pt;">
                                <p style='margin-top:0cm;margin-right:0cm;margin-bottom:0cm;margin-left:-26.65pt;text-align:center;text-indent:26.65pt;font-size:16px;font-family:"Times New Roman",serif;'>
                                <img src="{{ absolute_url(asset('ins-logo.png')) }}" alt="Logo Niger" style="height: 151; width: 108; "></div>
                            </p>
                            </td>
                            <td style="width:432.35pt;padding:0cm 5.4pt 0cm 5.4pt;height:130.4pt;">
                                <p style='margin-top:3.85pt;margin-right:84.1pt;margin-bottom:0cm;margin-left:8.8pt;font-size:21px;font-family:"Calibri",sans-serif;color:#231F20;'>&nbsp;</p>
                                <p style='margin-top:3.85pt;margin-right:84.1pt;margin-bottom:0cm;margin-left:8.8pt;font-size:21px;font-family:"Calibri",sans-serif;color:#231F20;'>R&Eacute;PUBLIQUE DU NIGER</p>
                                <p style='margin-top:1.0pt;margin-right:84.1pt;margin-bottom:0cm;margin-left:8.8pt;font-size:15px;font-family:"Calibri",sans-serif;color:#231F20;font-weight:bold;'>Fraternit&eacute; - Travail - Progr&egrave;s</p>
                                <p style='margin-top:.25pt;margin-right:84.1pt;margin-bottom:0cm;margin-left:8.8pt;line-height:16.35pt;font-size:18px;font-family:"Calibri",sans-serif;color:#414042;font-weight:bold;'>MINISTERE DE L&rsquo;ECONOMIE ET DES FINANCES</p>
                                <p style='margin-top:.25pt;margin-right:84.1pt;margin-bottom:0cm;margin-left:8.8pt;line-height:16.35pt;font-size:18px;font-family:"Calibri",sans-serif;color:#414042;font-weight:bold;'>INSTITUT NATIONAL DE LA STATISTIQUE</p>
                                <p style='margin-top:0cm;margin-right:84.2pt;margin-bottom:0cm;margin-left:8.8pt;font-size:15px;font-family:"Calibri",sans-serif;color:#414042;'>&Eacute;tablissement Public &agrave; Caract&egrave;re Administratif</p>
                                <p style='margin-top:0cm;margin-right:84.2pt;margin-bottom:0cm;margin-left:8.8pt;font-size:16px;font-family:"Calibri",sans-serif;color:#414042;font-weight:bold;'>Direction des Ressources Financi&egrave;res et du Mat&eacute;riel</p>
                                <p style='margin-top:0cm;margin-right:84.2pt;margin-bottom:0cm;margin-left:8.8pt;font-size:16px;font-family:"Calibri",sans-serif;color:#414042;'>Division du Mat&eacute;riel et de la Logistique</p>
                                <p style='margin-top:0cm;margin-right:84.2pt;margin-bottom:0cm;margin-left:8.8pt;font-size:16px;font-family:"Calibri",sans-serif;color:#414042;'>Service de la Logistique</p>
                                <p style='margin-top:0cm;margin-right:84.2pt;margin-bottom:0cm;margin-left:8.8pt;font-size:16px;font-family:"Calibri",sans-serif;color:#414042;'><span style="font-family:Calibri;color:black;">&nbsp;</span></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="document-title">FICHE D'ANOMALIES OU DE DEMANDE D'INTERVENTION</div>

            <table style="float: left;width:545.5pt;border-collapse:collapse;border:none;margin-left:4.8pt;margin-right:4.8pt;">
    <tbody>
        <tr>
            <td style="width: 545.5pt;border: 1pt solid windowtext;padding: 0cm 5.4pt;height: 527.8pt;vertical-align: top;">
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>N&deg; VEHICULE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;DIRECTION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;SIGNATURE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; DATE</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>${ligne[1].innerText} &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ******** &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 30/12/2024</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <table style="width:538.6pt;border-collapse:collapse;border:none;">
                    <tbody>
                        <tr>
                            <td style="width: 538.6pt;border: 1pt solid windowtext;padding: 0cm 5.4pt;height: 84.5pt;vertical-align: top;">
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strongANOMALIES CONSTATEES</strong><strong><span style="font-size:12px;"> </span></strong></p>
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:12px;">&nbsp;</span></strong></p>
                                <div style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'>
                                    <ul style="margin-bottom:0cm;list-style-type: disc;margin-left: 43.45px;">
                                        <li style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong> ${ligne[4].innerText}</strong></li>
                                    </ul>
                                </div>
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;margin-left:35.45pt;text-align:justify;'><strong>&nbsp;</strong></p>
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;margin-left:35.45pt;text-align:justify;'><strong>&nbsp;</strong></p>
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;margin-left:53.45pt;text-align:justify;'><strong>&nbsp;</strong></p>
                                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;margin-left:53.45pt;text-align:justify;'><strong>&nbsp;</strong></p>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">DATE DE DERNIERE INTERVENTION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;../../2025</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">LIEU DE L’INTERVENTION &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;</span> ${ligne[7].innerText} </strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">&nbsp; &nbsp; &nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">DATE D’ENTREE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &hellip; /&hellip;/2025</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">DATE DE SORTIE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &hellip;/&hellip;/2025</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">VISA DU CSL/INS   &nbsp; &nbsp; &nbsp;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;.. &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:13px;">VISA DU DML/INS  .&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">VISA DU DRFM/INS  &hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">VISA DU CMP/OB/INS &hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><span style="font-size:13px;">VISA DU SG/INS &hellip; &hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;&hellip;..</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:center;'><strong>&nbsp;</strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;'><strong><u><span style="font-size:13px;">APPROBATION DU DIRECTION GENERALE</span></u></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:19px;">&nbsp;</span></strong></p>
                <p style='margin:0cm;font-size:16px;font-family:"Times New Roman",serif;text-align:justify;'><strong><span style="font-size:19px;">&nbsp;</span></strong></p>
            </td>
        </tr>
    </tbody>
</table>
            <script>
                window.onload = function() {
                    window.print();
                };
            <\/script>
        </body>
        </html>
    `;

    var win = window.open("", "", "width=800,height=600");
    win.document.write(contenu);
    win.document.close();
}  
    




document.getElementById("addPieceForm").addEventListener("submit", function (e) {
    e.preventDefault();  // Empêche la soumission normale du formulaire

    const url = "{{ path('app_piece_new') }}";  // URL d'ajout de la pièce
    const formData = new FormData(this);  // Récupère les données du formulaire

    // Envoi AJAX
    fetch(url, {
        method: "POST",
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'  // Indique qu'il s'agit d'une requête AJAX
        }
    })
    .then(response => response.json())  // Récupère la réponse JSON du serveur
    .then(data => {
        if (data.success) {
            alert(data.message);  // Affiche le message de succès
            location.reload();  // Recharge la page pour afficher la nouvelle pièce
        } else {
            alert("Erreur lors de l'ajout de la pièce.");
        }
    })
    .catch(error => {
        console.error('Error:', error);  // Affiche l'erreur dans la console
    });

    // Masquer le modal après l'ajout
    const modal = new bootstrap.Modal(document.getElementById('addPieceModal'));
    modal.hide();
});







// Fermer le modal après mise à jour
document.getElementById("editPieceModal").classList.remove("show");
const editModal = bootstrap.Modal.getInstance(document.getElementById('editPieceModal'));
editModal.hide();

</script>
<script>



            // Gestion de l'édition des piece
                    document.querySelectorAll(".edit-btn_piece").forEach(button => {
                        button.addEventListener("click", function (event) {
                            event.preventDefault();
                            const pieceId = this.getAttribute("data-id");

                            fetch(`/piece/${pieceId}/edit`, {
                                headers: { "X-Requested-With": "XMLHttpRequest" }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.form) {
                                    document.getElementById("editModalContent").innerHTML = data.form;
                                    const editModal = new bootstrap.Modal(document.getElementById("editModal"));
                                    editModal.show();
                                }
                            })
                            .catch(error => console.error("Erreur lors du chargement du formulaire :", error));
                        });


                       
                    // Soumission du formulaire d'édition en AJAX
                    document.addEventListener("submit", function (event) {
                        if (event.target && event.target.matches("#editPieceForm")) {
                            event.preventDefault();
                            const form = event.target;
                            const formData = new FormData(form);
                            console.log("test")

                            fetch(form.action, {
                                method: "POST",
                                body: formData,
                                headers: { "X-Requested-With": "XMLHttpRequest" }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert("les données chaffeur mise à jour avec succès !");
                                    location.reload(); // Recharger la page après la modification
                                } else {
                                    alert("Erreur : " + data.errors);
                                }
                            })
                            .catch(error => console.error("Erreur lors de la mise à jour :", error));
                        }
                    });
            });

</script>


{% endblock %}
